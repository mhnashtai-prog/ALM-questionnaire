<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>INTUITY - Analytics DEBUG</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      height: 100vh;
      width: 100vw;
      overflow-x: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      position: relative;
      background: #000000;
    }

    .background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 30% 20%, rgba(255, 140, 60, 0.45) 0%, transparent 55%),
                  radial-gradient(circle at 70% 80%, rgba(255, 100, 40, 0.35) 0%, transparent 45%),
                  radial-gradient(circle at 20% 70%, rgba(200, 80, 30, 0.25) 0%, transparent 65%),
                  radial-gradient(circle at 90% 10%, rgba(255, 160, 80, 0.2) 0%, transparent 40%),
                  linear-gradient(135deg, #000000 0%, #000000 30%, #0a0503 70%, #000000 100%);
    }

    .container {
      position: relative;
      z-index: 10;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      font-weight: 800;
      color: #fff;
      margin-bottom: 8px;
      letter-spacing: 2px;
      text-shadow: 0 0 20px rgba(255, 140, 60, 0.3);
    }

    .header p {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 300;
    }

    .debug-panel {
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(255, 140, 60, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      color: #fff;
    }

    .debug-section {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border-left: 3px solid rgba(255, 140, 60, 0.5);
    }

    .debug-section h3 {
      color: rgba(255, 140, 60, 0.9);
      margin-bottom: 10px;
      font-size: 16px;
    }

    .debug-content {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 4px;
      white-space: pre-wrap;
      overflow-x: auto;
      color: #0f0;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .btn {
      background: rgba(255, 140, 60, 0.2);
      border: 1px solid rgba(255, 140, 60, 0.5);
      color: rgba(255, 140, 60, 0.9);
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .btn:hover {
      background: rgba(255, 140, 60, 0.3);
      color: #fff;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .status-item {
      color: #fff;
      font-size: 14px;
    }

    .status-value {
      color: rgba(255, 140, 60, 0.9);
      font-weight: 600;
    }

    .question-display {
      background: rgba(0, 0, 0, 0.6);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .question-text {
      color: #fff;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .question-dropdown {
      width: 100%;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      color: #fff;
      font-size: 14px;
    }

    .question-dropdown option {
      background: #000;
      color: #fff;
    }

    .footer {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    .nav-button {
      padding: 10px 20px;
      background: rgba(255, 140, 60, 0.2);
      border: 1px solid rgba(255, 140, 60, 0.3);
      color: rgba(255, 140, 60, 1);
      border-radius: 20px;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .nav-button:hover {
      background: rgba(255, 140, 60, 0.3);
      color: #fff;
    }

    .nav-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="background"></div>

  <div class="container">
    <header class="header">
      <h1>INTUITY DEBUG</h1>
      <p>Analytics Debugging Interface</p>
    </header>

    <div class="controls">
      <button class="btn" onclick="refreshData()">Refresh Data</button>
      <button class="btn" onclick="clearLocalStorage()">Clear LocalStorage</button>
      <button class="btn" onclick="createTestResponse()">Create Test Response</button>
      <button class="btn" id="displayBtn" onclick="launchDisplay()" disabled>Launch Display</button>
    </div>

    <div class="status">
      <div class="status-item">Questions: <span class="status-value" id="questionCount">0</span></div>
      <div class="status-item">Responses: <span class="status-value" id="responseCount">0</span></div>
      <div class="status-item">Current Question Responses: <span class="status-value" id="currentResponseCount">0</span></div>
    </div>

    <div class="question-display">
      <h3 style="color: rgba(255, 140, 60, 0.9); margin-bottom: 10px;">Current Question</h3>
      <div class="question-text" id="questionText">No question selected</div>
      <select class="question-dropdown" id="questionDropdown" onchange="handleQuestionChange()">
        <option value="">Loading...</option>
      </select>
    </div>

    <div class="debug-panel">
      <div class="debug-section">
        <h3>üìä LocalStorage Raw Data</h3>
        <div class="debug-content" id="localStorageDebug">Loading...</div>
      </div>

      <div class="debug-section">
        <h3>üìö Questions Array</h3>
        <div class="debug-content" id="questionsDebug">Loading...</div>
      </div>

      <div class="debug-section">
        <h3>üí¨ Responses Array</h3>
        <div class="debug-content" id="responsesDebug">Loading...</div>
      </div>

      <div class="debug-section">
        <h3>üéØ Current Question Analysis</h3>
        <div class="debug-content" id="currentQuestionDebug">Loading...</div>
      </div>
    </div>

    <div class="footer">
      <a href="../" class="nav-button">üè† Home</a>
      <a href="../teachers/questions/" class="nav-button">‚úèÔ∏è Create Questions</a>
      <a href="../displays/" class="nav-button">üì∫ Display</a>
    </div>
  </div>

  <script>
    let questions = [];
    let responses = [];
    let currentQuestion = null;

    // Initialize
    function init() {
      console.log('üöÄ DEBUG MODE: Initializing...');
      refreshData();
      
      // Auto-refresh every 3 seconds
      setInterval(refreshData, 3000);
    }

    // Refresh all data
    function refreshData() {
      console.log('üîÑ Refreshing data...');
      
      // Clear arrays
      questions = [];
      responses = [];
      
      loadLocalStorageData();
      updateDisplay();
    }

    // Load data from localStorage
    function loadLocalStorageData() {
      console.log('üì± Loading from localStorage...');
      
      try {
        // Load questions
        const storedQuestion = localStorage.getItem('current_question');
        if (storedQuestion) {
          const parsed = JSON.parse(storedQuestion);
          questions = Array.isArray(parsed) ? parsed : [parsed];
          console.log('üìö Loaded questions:', questions);
        } else {
          console.log('üìö No questions found in localStorage');
        }

        // Load responses
        const storedResponses = localStorage.getItem('alm_student_responses');
        if (storedResponses) {
          const parsedResponses = JSON.parse(storedResponses);
          console.log('üí¨ Raw responses from localStorage:', parsedResponses);
          
          if (Array.isArray(parsedResponses)) {
            responses = parsedResponses.map((r, index) => {
              console.log(`üí¨ Processing response ${index + 1}:`, r);
              return {
                id: r.id || `local_${index}`,
                question_id: r.questionId || r.question_id,
                student_name: r.studentName || r.student_name,
                answer: r.answer,
                word_count: r.wordCount || r.word_count,
                photo_url: r.photoUrl || r.photo_url,
                created_at: r.timestamp || r.created_at,
                original: r // Keep original for debugging
              };
            });
            console.log('üí¨ Processed responses:', responses);
          } else {
            console.log('üí¨ Responses data is not an array:', typeof parsedResponses);
            responses = [];
          }
        } else {
          console.log('üí¨ No responses found in localStorage');
          responses = [];
        }

      } catch (error) {
        console.error('‚ùå Error loading localStorage data:', error);
      }
    }

    // Update display
    function updateDisplay() {
      // Update status
      document.getElementById('questionCount').textContent = questions.length;
      document.getElementById('responseCount').textContent = responses.length;
      
      // Update question dropdown
      updateQuestionDropdown();
      
      // Update current question
      if (!currentQuestion && questions.length > 0) {
        currentQuestion = questions[0];
      }
      
      updateCurrentQuestion();
      updateDebugPanels();
    }

    // Update question dropdown
    function updateQuestionDropdown() {
      const dropdown = document.getElementById('questionDropdown');
      dropdown.innerHTML = '';
      
      if (questions.length === 0) {
        dropdown.innerHTML = '<option value="">No questions found</option>';
        return;
      }
      
      questions.forEach((q, index) => {
        const option = document.createElement('option');
        option.value = index;
        const questionText = q.text || q.question_text || 'Untitled';
        const responseCount = getResponseCountForQuestion(q);
        option.textContent = `Q${index + 1}: ${questionText.substring(0, 40)} (${responseCount} responses)`;
        dropdown.appendChild(option);
      });
      
      if (currentQuestion) {
        const currentIndex = questions.findIndex(q => q.id === currentQuestion.id);
        dropdown.value = currentIndex >= 0 ? currentIndex : 0;
      }
    }

    // Update current question display
    function updateCurrentQuestion() {
      const questionTextEl = document.getElementById('questionText');
      const currentResponseCountEl = document.getElementById('currentResponseCount');
      const displayBtn = document.getElementById('displayBtn');
      
      if (!currentQuestion) {
        questionTextEl.textContent = 'No question selected';
        currentResponseCountEl.textContent = '0';
        displayBtn.disabled = true;
        return;
      }
      
      const questionText = currentQuestion.text || currentQuestion.question_text || 'Untitled Question';
      questionTextEl.textContent = questionText;
      
      const responseCount = getResponseCountForQuestion(currentQuestion);
      currentResponseCountEl.textContent = responseCount;
      displayBtn.disabled = responseCount === 0;
      
      // Store for display
      if (responseCount > 0) {
        const questionForDisplay = {
          id: currentQuestion.id,
          text: questionText,
          question_text: questionText,
          questionText: questionText
        };
        
        const responsesForDisplay = getResponsesForQuestion(currentQuestion).map(r => ({
          id: r.id,
          student_name: r.student_name,
          studentName: r.student_name,
          answer: r.answer,
          word_count: r.word_count,
          photo_url: r.photo_url,
          created_at: r.created_at,
          question_id: currentQuestion.id,
          questionText: questionText
        }));
        
        localStorage.setItem('display_question', JSON.stringify(questionForDisplay));
        localStorage.setItem('display_responses', JSON.stringify(responsesForDisplay));
        
        console.log('üíæ Stored for display:', {
          question: questionForDisplay,
          responses: responsesForDisplay
        });
      }
    }

    // Get response count for question
    function getResponseCountForQuestion(question) {
      return getResponsesForQuestion(question).length;
    }

    // Get responses for specific question
    function getResponsesForQuestion(question) {
      if (!question) return [];
      
      const matchingResponses = responses.filter(r => {
        console.log(`üîç Matching response for question "${question.text || question.question_text}":`, {
          responseQuestionId: r.question_id,
          currentQuestionId: question.id,
          idMatch: r.question_id === question.id,
          response: r
        });
        
        // Try ID match
        if (r.question_id === question.id) return true;
        
        // Try text match
        const questionText = (question.text || question.question_text || '').trim().toLowerCase();
        const responseQuestionText = (r.original?.questionText || '').trim().toLowerCase();
        
        if (questionText && responseQuestionText && questionText === responseQuestionText) {
          return true;
        }
        
        // Demo mode
        if (question.id === 'demo' && r.question_id === 'demo') return true;
        
        return false;
      });
      
      console.log(`üéØ Found ${matchingResponses.length} responses for question "${question.text || question.question_text}"`);
      return matchingResponses;
    }

    // Update debug panels
    function updateDebugPanels() {
      // LocalStorage debug
      const localStorageData = {
        'alm_student_responses': localStorage.getItem('alm_student_responses'),
        'display_responses': localStorage.getItem('display_responses'),
        'current_question': localStorage.getItem('current_question'),
        'display_question': localStorage.getItem('display_question')
      };
      document.getElementById('localStorageDebug').textContent = JSON.stringify(localStorageData, null, 2);
      
      // Questions debug
      document.getElementById('questionsDebug').textContent = JSON.stringify(questions, null, 2);
      
      // Responses debug
      document.getElementById('responsesDebug').textContent = JSON.stringify(responses, null, 2);
      
      // Current question debug
      const currentQuestionAnalysis = {
        currentQuestion: currentQuestion,
        responsesForCurrent: currentQuestion ? getResponsesForQuestion(currentQuestion) : [],
        matchingLogic: currentQuestion ? {
          questionId: currentQuestion.id,
          questionText: currentQuestion.text || currentQuestion.question_text,
          totalResponses: responses.length,
          matchingResponses: currentQuestion ? getResponsesForQuestion(currentQuestion).length : 0
        } : null
      };
      document.getElementById('currentQuestionDebug').textContent = JSON.stringify(currentQuestionAnalysis, null, 2);
    }

    // Handle question selection
    function handleQuestionChange() {
      const selectedIndex = document.getElementById('questionDropdown').value;
      if (selectedIndex !== '' && questions[selectedIndex]) {
        currentQuestion = questions[selectedIndex];
        console.log('üéØ Selected question:', currentQuestion);
        updateCurrentQuestion();
        updateDebugPanels();
      }
    }

    // Clear localStorage
    function clearLocalStorage() {
      if (confirm('Clear all localStorage data?')) {
        localStorage.removeItem('alm_student_responses');
        localStorage.removeItem('display_responses');
        localStorage.removeItem('current_question');
        localStorage.removeItem('display_question');
        refreshData();
        console.log('üóëÔ∏è LocalStorage cleared');
      }
    }

    // Create test response
    function createTestResponse() {
      const testResponse = {
        id: 'test_' + Date.now(),
        questionId: currentQuestion?.id || 'demo',
        questionText: currentQuestion?.text || currentQuestion?.question_text || 'Test Question',
        studentName: 'Test Student',
        answer: 'This is a test response created at ' + new Date().toLocaleTimeString(),
        wordCount: 10,
        timestamp: new Date().toISOString(),
        photoUrl: null
      };
      
      // Get existing responses
      const existing = JSON.parse(localStorage.getItem('alm_student_responses') || '[]');
      existing.push(testResponse);
      
      // Save back
      localStorage.setItem('alm_student_responses', JSON.stringify(existing));
      
      console.log('üß™ Created test response:', testResponse);
      refreshData();
    }

    // Launch display
    function launchDisplay() {
      if (!currentQuestion) {
        alert('No question selected');
        return;
      }
      
      const responseCount = getResponseCountForQuestion(currentQuestion);
      if (responseCount === 0) {
        alert('No responses for this question');
        return;
      }
      
      console.log(`üöÄ Launching display with ${responseCount} responses`);
      window.open('../displays/', '_blank');
    }

    // Listen for localStorage changes
    window.addEventListener('storage', (e) => {
      if (e.key === 'alm_student_responses' || e.key === 'current_question') {
        console.log('üîÑ Storage changed:', e.key);
        refreshData();
      }
    });

    // Initialize on load
    document.addEventListener('DOMContentLoaded', init);

    // Make functions available in console
    window.refreshData = refreshData;
    window.createTestResponse = createTestResponse;
  </script>
</body>
</html>
