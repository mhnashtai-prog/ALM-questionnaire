<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ALM Analytics - Data Visualization</title>
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700;800;900&family=SF+Pro+Text:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      /* iPhone 15 Pro Color System */
      --bg-primary: #000000;
      --bg-secondary: #1C1C1E;
      --bg-tertiary: #2C2C2E;
      
      /* Dynamic Island Glass */
      --glass-primary: rgba(255, 255, 255, 0.1);
      --glass-secondary: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.15);
      --glass-strong: rgba(255, 255, 255, 0.2);
      
      /* iPhone System Colors */
      --system-blue: #007AFF;
      --system-green: #30D158;
      --system-orange: #FF9F0A;
      --system-red: #FF453A;
      --system-purple: #BF5AF2;
      --system-pink: #FF2D92;
      --system-teal: #64D2FF;
      --system-indigo: #5E5CE6;
      
      /* Text Hierarchy */
      --text-primary: #FFFFFF;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-tertiary: rgba(255, 255, 255, 0.5);
      --text-quaternary: rgba(255, 255, 255, 0.3);
      
      /* Spacing System */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --space-xxl: 48px;
      
      /* Effects */
      --blur-light: blur(20px);
      --blur-heavy: blur(40px);
      --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.3);
      --shadow-strong: 0 16px 64px rgba(0, 0, 0, 0.6);
      --glow-blue: 0 0 20px rgba(0, 122, 255, 0.4);
      --glow-green: 0 0 20px rgba(48, 209, 88, 0.4);
      --glow-orange: 0 0 20px rgba(255, 159, 10, 0.4);
      --glow-red: 0 0 20px rgba(255, 69, 58, 0.4);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* Ambient Background Animation */
    .ambient-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      opacity: 0.15;
    }

    .ambient-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      animation: float 20s ease-in-out infinite;
    }

    .orb-1 {
      width: 400px;
      height: 400px;
      background: linear-gradient(135deg, var(--system-blue), var(--system-purple));
      top: 10%;
      left: 20%;
      animation-delay: 0s;
    }

    .orb-2 {
      width: 300px;
      height: 300px;
      background: linear-gradient(135deg, var(--system-green), var(--system-teal));
      top: 60%;
      right: 20%;
      animation-delay: 7s;
    }

    .orb-3 {
      width: 200px;
      height: 200px;
      background: linear-gradient(135deg, var(--system-orange), var(--system-pink));
      bottom: 20%;
      left: 60%;
      animation-delay: 14s;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(30px, -30px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.9); }
    }

    /* Dynamic Island Header - MINIMAL */
    .dynamic-island {
      position: fixed;
      top: var(--space-lg);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: var(--blur-heavy);
      border: 1px solid var(--glass-border);
      border-radius: 40px;
      padding: var(--space-md) var(--space-xl);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: var(--space-md);
      box-shadow: var(--shadow-strong);
      max-width: 90%;
    }

    .question-indicator {
      background: linear-gradient(135deg, var(--system-orange), var(--system-pink));
      color: white;
      font-weight: 700;
      font-size: 1rem;
      padding: var(--space-sm) var(--space-md);
      border-radius: 16px;
      min-width: 60px;
      text-align: center;
    }

    .question-selector {
      background: var(--glass-secondary);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: var(--space-sm) var(--space-md);
      color: var(--text-primary);
      font-size: 0.875rem;
      cursor: pointer;
      min-width: 200px;
    }

    .response-count {
      background: var(--glass-primary);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: var(--space-xs) var(--space-sm);
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }

    /* Speech Bubbles Container */
    .speech-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10;
      padding: 120px var(--space-lg) 120px;
      overflow: hidden;
    }

    .speech-bubble {
      position: absolute;
      background: var(--glass-primary);
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--glass-border);
      border-radius: 32px;
      padding: var(--space-xl);
      max-width: 300px;
      min-width: 260px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: var(--shadow-soft);
      animation: speechFloat 8s ease-in-out infinite;
    }

    .speech-bubble::before {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border-style: solid;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    /* Speech bubble tail variants */
    .speech-bubble.tail-left::before {
      bottom: 30px;
      left: -12px;
      border-width: 12px 12px 12px 0;
      border-color: transparent var(--glass-border) transparent transparent;
    }

    .speech-bubble.tail-right::before {
      bottom: 30px;
      right: -12px;
      border-width: 12px 0 12px 12px;
      border-color: transparent transparent transparent var(--glass-border);
    }

    .speech-bubble.tail-bottom::before {
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 12px 12px 0 12px;
      border-color: var(--glass-border) transparent transparent transparent;
    }

    .speech-bubble:hover {
      transform: translateY(-8px) scale(1.02);
      background: var(--glass-strong);
      border-color: var(--system-blue);
      box-shadow: var(--glow-blue);
    }

    .speech-bubble.selected {
      background: var(--glass-strong);
      border-color: var(--system-blue);
      box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.3);
    }

    /* Quality-based styling */
    .speech-bubble.excellent {
      border-color: var(--system-green);
      background: linear-gradient(135deg, var(--glass-primary), rgba(48, 209, 88, 0.1));
    }

    .speech-bubble.excellent:hover {
      border-color: var(--system-green);
      box-shadow: var(--glow-green);
    }

    .speech-bubble.good {
      border-color: var(--system-orange);
      background: linear-gradient(135deg, var(--glass-primary), rgba(255, 159, 10, 0.1));
    }

    .speech-bubble.good:hover {
      border-color: var(--system-orange);
      box-shadow: var(--glow-orange);
    }

    .speech-bubble.needs-work {
      border-color: var(--system-red);
      background: linear-gradient(135deg, var(--glass-primary), rgba(255, 69, 58, 0.1));
    }

    .speech-bubble.needs-work:hover {
      border-color: var(--system-red);
      box-shadow: var(--glow-red);
    }

    @keyframes speechFloat {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(10px, -15px) rotate(0.5deg); }
      50% { transform: translate(-5px, -25px) rotate(-0.3deg); }
      75% { transform: translate(-10px, -15px) rotate(0.2deg); }
    }

    /* Student Avatar */
    .student-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--system-blue), var(--system-purple));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1.125rem;
      margin-bottom: var(--space-md);
      border: 2px solid var(--glass-border);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .student-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
      text-align: center;
    }

    .speech-content {
      font-family: 'SF Pro Text', system-ui, sans-serif;
      font-size: 0.875rem;
      line-height: 1.5;
      color: var(--text-secondary);
      margin-bottom: var(--space-md);
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-align: center;
    }

    .speech-stats {
      display: flex;
      justify-content: center;
      align-items: center;
      padding-top: var(--space-sm);
      border-top: 1px solid var(--glass-border);
      gap: var(--space-md);
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: 1rem;
    }

    .quality-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .excellent .quality-indicator {
      background: var(--system-green);
      box-shadow: 0 0 8px rgba(48, 209, 88, 0.5);
    }

    .good .quality-indicator {
      background: var(--system-orange);
      box-shadow: 0 0 8px rgba(255, 159, 10, 0.5);
    }

    .needs-work .quality-indicator {
      background: var(--system-red);
      box-shadow: 0 0 8px rgba(255, 69, 58, 0.5);
    }

    /* Detail Panel - MINIMAL */
    .detail-panel {
      position: fixed;
      right: -450px;
      top: 0;
      bottom: 0;
      width: 450px;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: var(--blur-heavy);
      border-left: 1px solid var(--glass-border);
      padding: var(--space-xxl);
      overflow-y: auto;
      transition: right 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      z-index: 2000;
    }

    .detail-panel.open {
      right: 0;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-xl);
    }

    .detail-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .close-btn {
      background: var(--glass-primary);
      border: 1px solid var(--glass-border);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: var(--system-red);
      border-color: var(--system-red);
    }

    .detail-content {
      font-family: 'SF Pro Text', system-ui, sans-serif;
      font-size: 1rem;
      line-height: 1.6;
      color: var(--text-secondary);
      margin-bottom: var(--space-xl);
      padding: var(--space-lg);
      background: var(--glass-secondary);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
    }

    .detail-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
    }

    .detail-stat {
      background: var(--glass-primary);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: var(--space-lg);
      text-align: center;
    }

    .detail-stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: var(--space-xs);
    }

    .detail-stat-emoji {
      font-size: 1.5rem;
      margin-bottom: var(--space-sm);
    }

    .detail-actions {
      display: flex;
      gap: var(--space-md);
    }

    .detail-btn {
      background: var(--glass-primary);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: var(--space-lg);
      font-size: 1.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .detail-btn:hover {
      background: var(--system-blue);
      border-color: var(--system-blue);
      box-shadow: var(--glow-blue);
    }

    /* Legend - VISUAL ONLY */
    .legend {
      position: fixed;
      top: 50%;
      left: var(--space-lg);
      transform: translateY(-50%);
      background: var(--glass-primary);
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: var(--space-lg);
      z-index: 90;
      box-shadow: var(--shadow-soft);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
      font-size: 1rem;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      flex-shrink: 0;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
    }

    /* Footer Pills - SUBTLE GLASSMORPHIC */
    .footer-pills {
      position: fixed;
      bottom: var(--space-lg);
      left: 50%;
      transform: translateX(-50%);
      background: var(--glass-primary);
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--glass-border);
      border-radius: 50px;
      padding: var(--space-sm);
      z-index: 1000;
      display: flex;
      gap: var(--space-xs);
      box-shadow: var(--shadow-soft);
    }

    .pill-icon {
      width: 44px;
      height: 44px;
      background: var(--glass-secondary);
      border: 1px solid var(--glass-border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.125rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      text-decoration: none;
      color: var(--text-tertiary);
    }

    .pill-icon:hover {
      background: var(--glass-strong);
      color: var(--text-primary);
      transform: translateY(-2px);
      border-color: var(--system-blue);
    }

    .pill-icon.active {
      background: var(--glass-strong);
      color: var(--system-orange);
      border-color: var(--system-orange);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .detail-panel {
        width: 100%;
        right: -100%;
      }
      
      .dynamic-island {
        flex-direction: column;
        gap: var(--space-sm);
        padding: var(--space-md);
      }
      
      .speech-bubble {
        max-width: 280px;
        min-width: 240px;
      }
      
      .legend {
        position: fixed;
        bottom: 120px;
        left: var(--space-md);
        top: auto;
        transform: none;
      }
    }

    @media (max-width: 480px) {
      .speech-bubble {
        max-width: 260px;
        min-width: 220px;
        padding: var(--space-md);
      }
      
      .student-avatar {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }
      
      .pill-icon {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="ambient-bg">
    <div class="ambient-orb orb-1"></div>
    <div class="ambient-orb orb-2"></div>
    <div class="ambient-orb orb-3"></div>
  </div>

  <!-- Dynamic Island Header -->
  <div class="dynamic-island">
    <div class="question-indicator" id="question-indicator">Q1</div>
    <select class="question-selector" id="question-selector" onchange="switchQuestion()">
      <option value="1">Question 1: Digital Technology Impact</option>
      <option value="2">Question 2: Online vs Traditional Learning</option>
      <option value="3">Question 3: Language Learning Strategies</option>
      <option value="4">Question 4: Cultural Understanding</option>
      <option value="5">Question 5: Motivation in Language Learning</option>
      <option value="6">Question 6: Assessment Methods</option>
    </select>
    <div class="response-count" id="response-count">
      💬 <span>6</span>
    </div>
  </div>

  <!-- Speech Bubbles Container -->
  <div class="speech-container" id="speech-container">
    <!-- Speech bubbles will be generated here -->
  </div>

  <!-- Footer Pills -->
  <div class="footer-pills">
    <a href="../teachers/questions/" class="pill-icon" title="Teacher">👩‍🏫</a>
    <a href="../students/answers/" class="pill-icon" title="Student">🎓</a>
    <button class="pill-icon active" onclick="refreshBubbles()" title="Analytics">📊</button>
    <button class="pill-icon" onclick="exportData()" title="Export">💾</button>
    <a href="../../" class="pill-icon" title="Home">🏠</a>
  </div>

  <!-- Legend -->
  <div class="legend">
    <div class="legend-item">
      <div class="legend-color" style="background: var(--system-green);"></div>
      <span>🟢</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: var(--system-orange);"></div>
      <span>🟡</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: var(--system-red);"></div>
      <span>🔴</span>
    </div>
  </div>

  <!-- Detail Panel -->
  <div class="detail-panel" id="detail-panel">
    <div class="detail-header">
      <div class="detail-title" id="detail-title">Student Response</div>
      <button class="close-btn" onclick="closeDetail()">❌</button>
    </div>
    <div id="detail-body">
      <!-- Dynamic content will be inserted here -->
    </div>
  </div>

  <script>
    const questionsData = {
      1: {
        text: "How has digital technology transformed modern education?",
        responses: [
          {
            id: 1,
            student: "Maria Rodriguez",
            avatar: "MR",
            answer: "Digital technology has fundamentally transformed modern education by providing interactive learning platforms, enabling distance learning, and creating personalized educational experiences that adapt to individual student needs and learning paces. The integration of AI-powered tutoring systems has revolutionized how we learn.",
            wordCount: 42,
            keywords: ["technology", "digital", "education", "learning"],
            timestamp: "2h",
            score: 95
          },
          {
            id: 2,
            student: "Ahmed Hassan",
            avatar: "AH",
            answer: "Technology revolutionizes classroom experiences through multimedia content, collaborative projects, and real-time feedback systems that enhance student engagement and comprehension.",
            wordCount: 23,
            keywords: ["technology", "digital"],
            timestamp: "1h",
            score: 78
          },
          {
            id: 3,
            student: "Sophie Chen",
            avatar: "SC",
            answer: "The digital transformation of education has created unprecedented opportunities for personalized learning experiences. Advanced educational technologies now allow teachers to track student progress in real-time and provide immediate feedback.",
            wordCount: 32,
            keywords: ["digital", "education", "learning", "technology"],
            timestamp: "30m",
            score: 92
          },
          {
            id: 4,
            student: "Carlos Rivera",
            avatar: "CR",
            answer: "Digital platforms have changed how we learn by making education more interactive and accessible. Students can now learn at their own pace.",
            wordCount: 22,
            keywords: ["digital", "education"],
            timestamp: "45m",
            score: 65
          },
          {
            id: 5,
            student: "Aisha Patel",
            avatar: "AP",
            answer: "Technology in education has transformed traditional teaching methods by introducing innovative digital tools that enhance learning outcomes and create dynamic learning environments.",
            wordCount: 24,
            keywords: ["technology", "education", "digital", "learning"],
            timestamp: "20m",
            score: 88
          },
          {
            id: 6,
            student: "Marcus Johnson",
            avatar: "MJ",
            answer: "Educational technology has revolutionized how knowledge is delivered and consumed in modern classrooms through virtual reality and AI-powered systems.",
            wordCount: 21,
            keywords: ["technology", "education", "digital"],
            timestamp: "10m",
            score: 85
          }
        ]
      }
    };

    let currentQuestion = 1;
    let selectedBubble = null;

    function generateSpeechBubbles() {
      const container = document.getElementById('speech-container');
      const questionData = questionsData[currentQuestion];
      
      if (!questionData) return;
      
      // Clear existing bubbles
      container.innerHTML = '';
      
      // Update header
      document.getElementById('question-indicator').textContent = `Q${currentQuestion}`;
      document.getElementById('response-count').innerHTML = `💬 <span>${questionData.responses.length}</span>`;
      
      const containerRect = container.getBoundingClientRect();
      const bubbleWidth = 280;
      const bubbleHeight = 200;
      const margin = 40;
      
      questionData.responses.forEach((response, index) => {
        const bubble = document.createElement('div');
        bubble.className = 'speech-bubble';
        
        // Add quality class
        if (response.score >= 85) {
          bubble.classList.add('excellent');
        } else if (response.score >= 70) {
          bubble.classList.add('good');
        } else {
          bubble.classList.add('needs-work');
        }
        
        // Add random tail direction
        const tailDirections = ['tail-left', 'tail-right', 'tail-bottom'];
        bubble.classList.add(tailDirections[index % 3]);
        
        // Position bubbles in organic layout
        const cols = Math.ceil(Math.sqrt(questionData.responses.length));
        const rows = Math.ceil(questionData.responses.length / cols);
        
        const colIndex = index % cols;
        const rowIndex = Math.floor(index / cols);
        
        const baseX = (containerRect.width / cols) * colIndex + (containerRect.width / cols - bubbleWidth) / 2;
        const baseY = (containerRect.height / rows) * rowIndex + (containerRect.height / rows - bubbleHeight) / 2;
        
        // Add some randomness for organic feel
        const randomX = (Math.random() - 0.5) * 100;
        const randomY = (Math.random() - 0.5) * 80;
        
        bubble.style.left = Math.max(margin, Math.min(containerRect.width - bubbleWidth - margin, baseX + randomX)) + 'px';
        bubble.style.top = Math.max(margin, Math.min(containerRect.height - bubbleHeight - margin, baseY + randomY)) + 'px';
        bubble.style.animationDelay = (index * 0.3) + 's';
        
        // Generate avatar colors
        const avatarColors = [
          'linear-gradient(135deg, var(--system-blue), var(--system-purple))',
          'linear-gradient(135deg, var(--system-green), var(--system-teal))',
          'linear-gradient(135deg, var(--system-orange), var(--system-pink))',
          'linear-gradient(135deg, var(--system-red), var(--system-purple))',
          'linear-gradient(135deg, var(--system-indigo), var(--system-blue))',
          'linear-gradient(135deg, var(--system-teal), var(--system-green))'
        ];
        
        bubble.innerHTML = `
          <div class="student-avatar" style="background: ${avatarColors[index % avatarColors.length]}">
            ${response.avatar}
          </div>
          <div class="student-name">${response.student}</div>
          <div class="speech-content">${response.answer}</div>
          <div class="speech-stats">
            <div class="stat-item">
              <div class="quality-indicator"></div>
            </div>
            <div class="stat-item">
              📝 ${response.wordCount}
            </div>
            <div class="stat-item">
              🔑 ${response.keywords.length}
            </div>
          </div>
        `;
        
        bubble.addEventListener('click', () => showDetail(response));
        container.appendChild(bubble);
      });
    }

    function showDetail(response) {
      const panel = document.getElementById('detail-panel');
      const title = document.getElementById('detail-title');
      const body = document.getElementById('detail-body');
      
      title.textContent = response.student;
      
      body.innerHTML = `
        <div class="detail-stats-grid">
          <div class="detail-stat">
            <div class="detail-stat-emoji">🏆</div>
            <div class="detail-stat-value">${response.score}%</div>
          </div>
          <div class="detail-stat">
            <div class="detail-stat-emoji">📝</div>
            <div class="detail-stat-value">${response.wordCount}</div>
          </div>
          <div class="detail-stat">
            <div class="detail-stat-emoji">🔑</div>
            <div class="detail-stat-value">${response.keywords.length}/4</div>
          </div>
          <div class="detail-stat">
            <div class="detail-stat-emoji">⏰</div>
            <div class="detail-stat-value">${response.timestamp}</div>
          </div>
        </div>
        
        <div class="detail-content">
          ${response.answer}
        </div>
        
        <div class="detail-actions">
          <button class="detail-btn" onclick="highlightKeywords(${response.id})">
            🔍
          </button>
          <button class="detail-btn" onclick="startDiscussion(${response.id})">
            💬
          </button>
        </div>
      `;
      
      panel.classList.add('open');
      
      // Highlight selected bubble
      document.querySelectorAll('.speech-bubble').forEach(bubble => bubble.classList.remove('selected'));
      selectedBubble = response.id;
    }

    function closeDetail() {
      document.getElementById('detail-panel').classList.remove('open');
      document.querySelectorAll('.speech-bubble').forEach(bubble => bubble.classList.remove('selected'));
      selectedBubble = null;
    }

    function switchQuestion() {
      currentQuestion = parseInt(document.getElementById('question-selector').value);
      generateSpeechBubbles();
      closeDetail();
    }

    function refreshBubbles() {
      generateSpeechBubbles();
      
      // Show success animation
      const animation = document.createElement('div');
      animation.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 4rem;
        z-index: 3000;
        animation: successPop 1s ease-out;
        pointer-events: none;
      `;
      animation.textContent = '🔄';
      
      const style = document.createElement('style');
      style.textContent = `
        @keyframes successPop {
          0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
          50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(animation);
      
      setTimeout(() => {
        animation.remove();
        style.remove();
      }, 1000);
    }

    function exportData() {
      const animation = document.createElement('div');
      animation.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 4rem;
        z-index: 3000;
        animation: successPop 1s ease-out;
        pointer-events: none;
      `;
      animation.textContent = '📥';
      
      document.body.appendChild(animation);
      
      setTimeout(() => animation.remove(), 1000);
    }

    function highlightKeywords(responseId) {
      const animation = document.createElement('div');
      animation.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 4rem;
        z-index: 3000;
        animation: successPop 1s ease-out;
        pointer-events: none;
      `;
      animation.textContent = '🔍';
      
      document.body.appendChild(animation);
      
      setTimeout(() => animation.remove(), 1000);
    }

    function startDiscussion(responseId) {
      const animation = document.createElement('div');
      animation.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 4rem;
        z-index: 3000;
        animation: successPop 1s ease-out;
        pointer-events: none;
      `;
      animation.textContent = '💬';
      
      document.body.appendChild(animation);
      
      setTimeout(() => animation.remove(), 1000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      generateSpeechBubbles();
      
      // Auto-refresh bubbles periodically for dynamic effect
      setInterval(() => {
        if (!selectedBubble) {
          const bubbles = document.querySelectorAll('.speech-bubble');
          bubbles.forEach((bubble, index) => {
            bubble.style.animation = 'none';
            bubble.offsetHeight; // Trigger reflow
            bubble.style.animation = `speechFloat ${8 + Math.random() * 2}s ease-in-out infinite`;
            bubble.style.animationDelay = (index * 0.3) + 's';
          });
        }
      }, 12000);
    });

    // Handle window resize
    window.addEventListener('resize', () => {
      setTimeout(generateSpeechBubbles, 100);
    });

    // Close detail panel when clicking outside
    document.addEventListener('click', (e) => {
      if (e.target.closest('.detail-panel') === null && 
          e.target.closest('.speech-bubble') === null &&
          document.getElementById('detail-panel').classList.contains('open')) {
        closeDetail();
      }
    });
  </script>
</body>
</html>
