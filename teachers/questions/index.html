<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>INTUITY - Student Response DEBUG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      width: 100vw;
      overflow-x: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      position: relative;
      background: #000000;
    }

    .background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 30% 20%, rgba(255, 140, 60, 0.45) 0%, transparent 55%),
                  radial-gradient(circle at 70% 80%, rgba(255, 100, 40, 0.35) 0%, transparent 45%),
                  radial-gradient(circle at 20% 70%, rgba(200, 80, 30, 0.25) 0%, transparent 65%),
                  radial-gradient(circle at 90% 10%, rgba(255, 160, 80, 0.2) 0%, transparent 40%),
                  linear-gradient(135deg, #000000 0%, #000000 30%, #0a0503 70%, #000000 100%);
    }

    .container {
      position: relative;
      z-index: 10;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      font-weight: 800;
      color: #fff;
      margin-bottom: 8px;
      letter-spacing: 2px;
      text-shadow: 0 0 20px rgba(255, 140, 60, 0.3);
    }

    .header p {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 300;
      letter-spacing: 0.5px;
    }

    /* Question Display */
    .question-display {
      background: rgba(0, 0, 0, 0.6);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    .question-text {
      color: #fff;
      font-size: 18px;
      opacity: 0.7;
    }

    /* Response Form */
    .response-form {
      background: #000000;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      margin-bottom: 8px;
      display: block;
    }

    .form-input {
      width: 100%;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 16px;
      font-family: inherit;
      outline: none;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .form-input:focus {
      border-bottom-color: rgba(255, 140, 60, 0.6);
    }

    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
      font-style: italic;
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 15px;
    }

    .form-textarea:focus {
      border-color: rgba(255, 140, 60, 0.6);
    }

    /* Submit Button */
    .submit-section {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    .btn {
      background: rgba(255, 140, 60, 0.2);
      border: 1px solid rgba(255, 140, 60, 0.5);
      color: rgba(255, 140, 60, 0.9);
      padding: 15px 30px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn:hover {
      background: rgba(255, 140, 60, 0.3);
      color: #fff;
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn.primary {
      background: rgba(255, 140, 60, 0.8);
      color: #000;
    }

    .btn.primary:hover {
      background: rgba(255, 140, 60, 1);
    }

    /* Debug Panel */
    .debug-panel {
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid rgba(255, 140, 60, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .debug-section {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border-left: 3px solid rgba(255, 140, 60, 0.5);
    }

    .debug-section h4 {
      color: rgba(255, 140, 60, 0.9);
      margin-bottom: 10px;
      font-size: 14px;
    }

    .debug-content {
      font-family: 'Courier New', monospace;
      font-size: 11px;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 4px;
      white-space: pre-wrap;
      overflow-x: auto;
      color: #0f0;
      max-height: 200px;
      overflow-y: auto;
    }

    /* Status Messages */
    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: 500;
    }

    .status-success {
      background: rgba(16, 185, 129, 0.2);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: rgba(16, 185, 129, 0.9);
    }

    .status-error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: rgba(239, 68, 68, 0.9);
    }

    .status-info {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: rgba(59, 130, 246, 0.9);
    }

    /* Footer */
    .footer {
      margin-top: 20px;
      text-align: center;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .response-form {
        padding: 20px;
      }
      
      .btn {
        padding: 12px 20px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="background"></div>

  <div class="container">
    <header class="header">
      <h1>INTUITY DEBUG</h1>
      <p>Student Response Interface<br>DEBUG MODE</p>
    </header>

    <!-- Question Display -->
    <div class="question-display">
      <div class="question-text" id="questionText">Loading question...</div>
    </div>

    <!-- Response Form -->
    <div class="response-form">
      <div class="form-group">
        <label class="form-label">Student Name</label>
        <input 
          type="text" 
          class="form-input" 
          id="studentName"
          placeholder="Enter your name..."
          maxlength="50"
        />
      </div>
      
      <div class="form-group">
        <label class="form-label">Your Answer</label>
        <textarea 
          class="form-input form-textarea" 
          id="studentAnswer"
          placeholder="Type your answer here..."
        ></textarea>
      </div>
      
      <div class="submit-section">
        <button class="btn" onclick="clearForm()">Clear</button>
        <button class="btn" onclick="testLocalStorage()">Test Storage</button>
        <button class="btn primary" id="submitBtn" onclick="submitResponse()" disabled>Submit Response</button>
      </div>
    </div>

    <!-- Status Messages -->
    <div id="statusMessages"></div>

    <!-- Debug Panel -->
    <div class="debug-panel">
      <h3 style="color: rgba(255, 140, 60, 0.9); margin-bottom: 15px; text-align: center;">üîß Debug Information</h3>
      
      <div class="debug-section">
        <h4>üìù Current Form Data</h4>
        <div class="debug-content" id="formDataDebug">No data</div>
      </div>

      <div class="debug-section">
        <h4>üíæ LocalStorage Content</h4>
        <div class="debug-content" id="localStorageDebug">Loading...</div>
      </div>

      <div class="debug-section">
        <h4>üìã Submission Log</h4>
        <div class="debug-content" id="submissionLog">No submissions yet</div>
      </div>

      <div class="debug-section">
        <h4>‚öôÔ∏è Browser Info</h4>
        <div class="debug-content" id="browserInfo">Loading...</div>
      </div>
    </div>

    <div class="footer">
      <a href="../" class="btn">üè† Home</a>
      <a href="../visualisation/" class="btn">üìä Analytics</a>
    </div>
  </div>

  <script>
    // Global variables
    let currentQuestion = null;
    let submissionLog = [];

    // Initialize
    function init() {
      console.log('üöÄ DEBUG MODE: Student interface initializing...');
      
      loadQuestion();
      setupEventListeners();
      updateDebugPanels();
      checkBrowserCapabilities();
      
      // Update debug info every 2 seconds
      setInterval(updateDebugPanels, 2000);
      
      logMessage('üöÄ Debug interface initialized');
    }

    // Load question
    function loadQuestion() {
      // Try URL parameters first
      const urlParams = new URLSearchParams(window.location.search);
      const questionText = urlParams.get('t');
      
      if (questionText) {
        currentQuestion = {
          id: urlParams.get('q') || 'demo',
          text: decodeURIComponent(questionText),
          source: 'url'
        };
        displayQuestion();
        return;
      }
      
      // Try localStorage
      const storedQuestion = localStorage.getItem('current_question');
      if (storedQuestion) {
        try {
          const parsed = JSON.parse(storedQuestion);
          currentQuestion = Array.isArray(parsed) ? parsed[0] : parsed;
          displayQuestion();
          return;
        } catch (error) {
          logMessage('‚ö†Ô∏è Error parsing stored question: ' + error.message, 'error');
        }
      }
      
      // Fallback to demo
      currentQuestion = {
        id: 'demo',
        text: 'Demo: What would you like to learn today?',
        source: 'demo'
      };
      displayQuestion();
    }

    // Display question
    function displayQuestion() {
      const questionElement = document.getElementById('questionText');
      if (currentQuestion) {
        questionElement.textContent = currentQuestion.text || currentQuestion.question_text || 'Demo Question';
        logMessage('üìù Question loaded: ' + (currentQuestion.text || currentQuestion.question_text));
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      document.getElementById('studentName').addEventListener('input', handleInput);
      document.getElementById('studentAnswer').addEventListener('input', handleInput);
    }

    // Handle input changes
    function handleInput() {
      const name = document.getElementById('studentName').value.trim();
      const answer = document.getElementById('studentAnswer').value.trim();
      const submitBtn = document.getElementById('submitBtn');
      
      submitBtn.disabled = !(name && answer);
      
      updateDebugPanels();
    }

    // Test localStorage
    function testLocalStorage() {
      logMessage('üß™ Testing localStorage...', 'info');
      
      try {
        // Test basic functionality
        localStorage.setItem('test_key', 'test_value');
        const testValue = localStorage.getItem('test_key');
        
        if (testValue === 'test_value') {
          logMessage('‚úÖ localStorage is working', 'success');
          localStorage.removeItem('test_key');
        } else {
          logMessage('‚ùå localStorage read/write failed', 'error');
        }
        
        // Test with complex data
        const testData = {
          timestamp: new Date().toISOString(),
          test: true,
          data: [1, 2, 3]
        };
        
        localStorage.setItem('test_complex', JSON.stringify(testData));
        const retrievedData = JSON.parse(localStorage.getItem('test_complex'));
        
        if (retrievedData.test === true) {
          logMessage('‚úÖ localStorage complex data works', 'success');
          localStorage.removeItem('test_complex');
        } else {
          logMessage('‚ùå localStorage complex data failed', 'error');
        }
        
      } catch (error) {
        logMessage('‚ùå localStorage error: ' + error.message, 'error');
      }
      
      updateDebugPanels();
    }

    // Submit response - DETAILED DEBUG VERSION
    function submitResponse() {
      const nameInput = document.getElementById('studentName');
      const answerInput = document.getElementById('studentAnswer');
      const submitBtn = document.getElementById('submitBtn');
      
      const studentName = nameInput.value.trim();
      const studentAnswer = answerInput.value.trim();
      
      logMessage('üöÄ Starting submission process...', 'info');
      logMessage(`üìù Name: "${studentName}", Answer length: ${studentAnswer.length}`);
      
      if (!studentName || !studentAnswer) {
        logMessage('‚ùå Validation failed: missing name or answer', 'error');
        return;
      }

      // Show loading
      submitBtn.innerHTML = '‚è≥ Submitting...';
      submitBtn.disabled = true;

      try {
        // Create response object
        const timestamp = new Date().toISOString();
        const questionId = currentQuestion?.id || 'demo';
        const questionText = currentQuestion?.text || currentQuestion?.question_text || 'Demo Question';
        
        const response = {
          id: 'student_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          questionId: questionId,
          questionText: questionText,
          studentName: studentName,
          answer: studentAnswer,
          wordCount: studentAnswer.split(/\s+/).filter(word => word.length > 0).length,
          timestamp: timestamp,
          photoUrl: null
        };

        logMessage('üì¶ Created response object:');
        logMessage(JSON.stringify(response, null, 2));

        // Get existing responses from localStorage
        let existingResponses = [];
        try {
          const stored = localStorage.getItem('alm_student_responses');
          logMessage('üì• Existing localStorage data:');
          logMessage(stored || 'NULL');
          
          if (stored) {
            existingResponses = JSON.parse(stored) || [];
            logMessage(`üìã Found ${existingResponses.length} existing responses`);
          } else {
            logMessage('üìã No existing responses found');
          }
        } catch (parseError) {
          logMessage('‚ö†Ô∏è Error parsing existing responses: ' + parseError.message, 'error');
          existingResponses = [];
        }

        // Add new response
        existingResponses.push(response);
        logMessage(`üìù Total responses after adding new: ${existingResponses.length}`);
        
        // Save to localStorage
        const dataToSave = JSON.stringify(existingResponses);
        logMessage('üíæ Attempting to save to localStorage...');
        logMessage('üíæ Data to save (first 200 chars):');
        logMessage(dataToSave.substring(0, 200) + (dataToSave.length > 200 ? '...' : ''));
        
        localStorage.setItem('alm_student_responses', dataToSave);
        
        // Verify it was saved
        const verification = localStorage.getItem('alm_student_responses');
        if (verification) {
          const parsed = JSON.parse(verification);
          logMessage(`‚úÖ Successfully saved ${parsed.length} responses to localStorage`, 'success');
        } else {
          logMessage('‚ùå Failed to save to localStorage - data not found after save', 'error');
        }

        // Also save in display format
        const displayResponses = JSON.parse(localStorage.getItem('display_responses') || '[]');
        const displayFormat = {
          ...response,
          student_name: response.studentName,
          created_at: response.timestamp,
          question_id: response.questionId
        };
        displayResponses.unshift(displayFormat);
        localStorage.setItem('display_responses', JSON.stringify(displayResponses));
        logMessage('üíæ Also saved in display format');

        // Update current question
        if (currentQuestion) {
          localStorage.setItem('current_question', JSON.stringify(currentQuestion));
          logMessage('üíæ Updated current question');
        }

        // Show success
        showSuccess();
        logMessage('üéâ Submission completed successfully!', 'success');
        
      } catch (error) {
        logMessage('‚ùå Error during submission: ' + error.message, 'error');
        logMessage('‚ùå Error stack: ' + error.stack);
        submitBtn.innerHTML = 'Submit Response';
        submitBtn.disabled = false;
      }
      
      updateDebugPanels();
    }

    // Show success
    function showSuccess() {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.innerHTML = '‚úÖ Submitted!';
      submitBtn.style.background = 'rgba(16, 185, 129, 0.8)';
      
      // Clear form
      document.getElementById('studentName').value = '';
      document.getElementById('studentAnswer').value = '';
      
      setTimeout(() => {
        submitBtn.innerHTML = 'Submit Response';
        submitBtn.style.background = '';
        submitBtn.disabled = true;
      }, 3000);
    }

    // Clear form
    function clearForm() {
      document.getElementById('studentName').value = '';
      document.getElementById('studentAnswer').value = '';
      document.getElementById('submitBtn').disabled = true;
      logMessage('üóëÔ∏è Form cleared');
      updateDebugPanels();
    }

    // Update debug panels
    function updateDebugPanels() {
      // Form data
      const formData = {
        studentName: document.getElementById('studentName').value,
        studentAnswer: document.getElementById('studentAnswer').value,
        answerLength: document.getElementById('studentAnswer').value.length,
        wordCount: document.getElementById('studentAnswer').value.split(/\s+/).filter(word => word.length > 0).length,
        currentQuestion: currentQuestion,
        submitButtonDisabled: document.getElementById('submitBtn').disabled
      };
      document.getElementById('formDataDebug').textContent = JSON.stringify(formData, null, 2);
      
      // localStorage
      const localStorageData = {
        'alm_student_responses': localStorage.getItem('alm_student_responses'),
        'display_responses': localStorage.getItem('display_responses'),
        'current_question': localStorage.getItem('current_question'),
        'display_question': localStorage.getItem('display_question'),
        localStorageLength: localStorage.length,
        keys: Object.keys(localStorage)
      };
      document.getElementById('localStorageDebug').textContent = JSON.stringify(localStorageData, null, 2);
      
      // Submission log
      document.getElementById('submissionLog').textContent = submissionLog.join('\n');
    }

    // Check browser capabilities
    function checkBrowserCapabilities() {
      const info = {
        userAgent: navigator.userAgent,
        localStorage: typeof(Storage) !== "undefined",
        localStorageQuota: 'unknown',
        cookiesEnabled: navigator.cookieEnabled,
        onLine: navigator.onLine,
        language: navigator.language,
        platform: navigator.platform,
        url: window.location.href,
        timestamp: new Date().toISOString()
      };
      
      // Test localStorage quota
      try {
        let testString = '';
        for (let i = 0; i < 1000; i++) {
          testString += 'x';
        }
        localStorage.setItem('quota_test', testString);
        localStorage.removeItem('quota_test');
        info.localStorageQuota = 'working (tested 1KB)';
      } catch (error) {
        info.localStorageQuota = 'error: ' + error.message;
      }
      
      document.getElementById('browserInfo').textContent = JSON.stringify(info, null, 2);
    }

    // Log message
    function logMessage(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}`;
      
      submissionLog.push(logEntry);
      
      // Keep only last 20 messages
      if (submissionLog.length > 20) {
        submissionLog = submissionLog.slice(-20);
      }
      
      console.log(logEntry);
      
      // Show status message
      showStatusMessage(message, type);
    }

    // Show status message
    function showStatusMessage(message, type) {
      const statusContainer = document.getElementById('statusMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `status-message status-${type}`;
      messageDiv.textContent = message;
      
      statusContainer.insertBefore(messageDiv, statusContainer.firstChild);
      
      // Remove after 5 seconds
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, 5000);
      
      // Keep only last 3 messages visible
      const messages = statusContainer.querySelectorAll('.status-message');
      if (messages.length > 3) {
        messages[messages.length - 1].remove();
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', init);

    // Make functions available in console
    window.testLocalStorage = testLocalStorage;
    window.updateDebugPanels = updateDebugPanels;
  </script>
</body>
</html>
